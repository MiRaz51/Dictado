<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- AplicaciÃ³n optimizada para escritorio -->
  <title>PrÃ¡ctica de OrtografÃ­a</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles/variables.css">
  <link rel="stylesheet" href="assets/styles/base.css">
  <link rel="stylesheet" href="assets/styles/utilities.css">
  <link rel="stylesheet" href="assets/styles/forms.css">
  <link rel="stylesheet" href="assets/styles.css">
  <!-- CSS modularizado: componentes -->
  <link rel="stylesheet" href="assets/styles/components/help-button.css">
  <link rel="stylesheet" href="assets/styles/components/tutorial.css">
  <link rel="stylesheet" href="assets/styles/components/config-card.css">
  <link rel="stylesheet" href="assets/styles/components/progress.css">
  <link rel="stylesheet" href="assets/styles/components/participant.css">
  <link rel="stylesheet" href="assets/styles/components/tutor.css">
  <link rel="stylesheet" href="assets/styles/components/virtual-keyboard.css">
  <link rel="stylesheet" href="assets/styles/components/reportes.css">
  <link rel="stylesheet" href="assets/styles/components/badges.css">
  <link rel="stylesheet" href="assets/styles/components/feedback.css">
  <!-- Simple Keyboard CSS (solo se usa en mÃ³viles/tablets) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-keyboard@latest/build/css/index.css">
  <script src="modules/word-filters-fixed.js" onload="console.log('âœ… modules/word-filters-fixed.js cargado')" onerror="console.error('âŒ Error cargando modules/word-filters-fixed.js')"></script>
  <script src="modules/filters.js" onload="console.log('âœ… modules/filters.js cargado')" onerror="console.error('âŒ Error cargando modules/filters.js')"></script>
</head>
<body>
  <!-- BotÃ³n de ayuda/tutorial (flotante, fuera del contenedor principal) -->
  <button id="help-btn" class="help-button" onclick="window.PageHints && window.PageHints.showCurrent && window.PageHints.showCurrent();" title="Ver ayuda de esta pÃ¡gina">
    <span>?</span>
  </button>
  <!-- Eliminado: script inline duplicado. Todas las funciones reales estÃ¡n en app.js -->
  <div class="container">
  
  <h2><span class="brand">PrÃ¡ctica</span> de OrtografÃ­a</h2>
  <p id="metaAlumnoCurso" class="meta" style="display:none;"></p>

  <!-- PÃ¡gina 0: SelecciÃ³n de Modo -->
  <section id="page-mode-select" class="page active">
    <div class="card" style="text-align: center;">
      <h3 style="margin-bottom: 20px; color: var(--text);">Selecciona el modo de prÃ¡ctica</h3>
      <div class="mode-grid">
        <div id="modeIndividual" class="mode-card" role="button" tabindex="0" onclick="selectMode('individual')">
          <div class="mode-icon">ğŸ‘¤</div>
          <h4>Individual</h4>
          <p>PrÃ¡ctica personal independiente</p>
        </div>

        <div id="modeGroup" class="mode-card" role="button" tabindex="0" onclick="selectMode('group')">
          <div class="mode-icon">ğŸ‘¥</div>
          <h4>Grupal</h4>
          <p>SesiÃ³n colaborativa con tutor</p>
        </div>
      </div>
    </div>
  </section>

  <!-- PÃ¡gina 0.5: SelecciÃ³n de Rol Grupal -->
  <section id="page-role-select" class="page">
    <div class="card" style="text-align: center;">
      <h3 style="margin-bottom: 20px; color: var(--text);">Selecciona tu rol</h3>
      <div class="mode-grid">
        <div class="mode-card" onclick="selectRole('tutor')">
          <div class="mode-icon">ğŸ“</div>
          <h4>Tutor/Administrador</h4>
          <p>Crear y gestionar la sesiÃ³n</p>
        </div>
        <div class="mode-card" onclick="selectRole('participant')">
          <div class="mode-icon">ğŸ“</div>
          <h4>Participante/Alumno</h4>
          <p>Unirse a una sesiÃ³n existente</p>
        </div>
      </div>
      <div class="actions" style="margin-top: 20px;">
        <button class="btn-ghost" onclick="goToPage('page-mode-select')">â—‚ Volver</button>
      </div>
    </div>
  </section>

  <!-- PÃ¡gina 1: ConfiguraciÃ³n -->
  <section id="page-config" class="page">
    <div class="card" style="margin: 12px 0;">
      <div class="form-row">
        <div class="form-field" style="grid-column: 1 / -1;">
          <label for="alumno"><strong>Participante</strong>:</label>
          <input id="alumno" type="text" placeholder="Nombre y apellido" tabindex="1" oninput="validateFields()" onkeydown="handleEnterNavigation(event, 'btnNext')" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
          <div id="alumnoError" class="help-error">Este campo es obligatorio.</div>
        </div>
      </div>
    </div>
    <div class="actions">
      <button id="btnNext" class="btn-ghost" onclick="goNextFromConfig()" disabled tabindex="6">Siguiente â–¸</button>
    </div>
  </section>

  <!-- PÃ¡gina 2: Ejercicio -->
  <section id="page-game" class="page">
    <div class="card" style="margin: 12px 0;">
      <div id="config-individual-block"></div>
    </div>
    
    <p>Selecciona un nivel de dificultad:</p>
    
    <div class="actions" style="margin-top: 6px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <button id="btnVolverGame" class="btn-ghost" onclick="goToPage('page-config')">â—‚ Volver</button>
      <button id="btnNivelBasico" onkeydown="handleArrowNavigation(event, 'btnNivelIntermedio', 'btnNivelExperto')" tabindex="7">ğŸŒ± Nivel BÃ¡sico</button>
      <button id="btnNivelIntermedio" onkeydown="handleArrowNavigation(event, 'btnNivelAvanzado', 'btnNivelBasico')" tabindex="8">ğŸŒ¿ Nivel Intermedio</button>
      <button id="btnNivelAvanzado" onkeydown="handleArrowNavigation(event, 'btnNivelExperto', 'btnNivelIntermedio')" tabindex="9">ğŸŒ³ Nivel Avanzado</button>
      <button id="btnNivelExperto" onkeydown="handleArrowNavigation(event, 'btnNivelBasico', 'btnNivelAvanzado')" tabindex="10">ğŸ”¥ Nivel Experto</button>
      <button class="btn-ghost" type="button" onclick="refrescarDatosRAE()" title="Limpiar cachÃ© del JSON y recargar">â†» Refrescar datos</button>
      <span id="nivelesDiag" class="hint" style="font-size:12px; color:#666; display:none;"></span>
    </div>
    <div id="juego" class="card" style="display:none; margin-top:14px;">
      <div class="avance-row">
        <div class="progress" aria-label="Progreso de palabras">
          <div id="progressFill" class="progress-fill" style="width:0%"></div>
        </div>
        <div id="progressText" class="progress-text">0/0</div>
      </div>
      <div class="row layout-game-input" style="margin-top:6px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <button id="btnSpeak" onclick="reproducirPalabra(true)">ğŸ”Š Reproducir palabra</button>
        <button id="btnEnableAudio" class="btn-ghost" style="display:none;" onclick="unlockTTS(); reproducirPalabra(true)">Permitir audio</button>
        <input type="text" id="respuesta" placeholder="Escribe aquÃ­" style="flex: 1 1 200px; min-width: 0; max-width: 100%;" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-ms-editor="false" data-gramm="false" data-gramm_editor="false" data-enable-grammarly="false" data-gramm-mode="false" data-lt-installed="false">
        <!-- Espejo visual del input (mÃ³vil/tablet) para mostrar un caret falso en la misma posiciÃ³n -->
        <div id="vkMirror" class="vk-mirror" aria-hidden="false" style="flex: 1 1 200px; min-width: 0;">
          <span class="vk-mirror-text"></span><span class="vk-caret"></span>
        </div>
        <button id="btnComprobar" onclick="comprobar()">Comprobar</button>
      </div>
      <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
        <p id="resultado" class="status"></p>
        <p id="marcador" class="status"></p>
      </div>
      <div class="actions" style="margin-top:8px;">
        <button id="btnToReport" style="display:none;" onclick="goToReportFromGame()">Siguiente â–¸</button>
      </div>
    </div>
  </section>

  <!-- PÃ¡gina 2.4: InformaciÃ³n del Tutor (nueva) -->
  <section id="page-tutor-info" class="page">
    <div class="card">
      <h3>ğŸ“ InformaciÃ³n del Tutor</h3>
      
      <div class="form-field">
        <label for="tutorName"><strong>Tutor/Administrador:</strong></label>
        <input id="tutorName" type="text" placeholder="Ingresa tu nombre como tutor" tabindex="1" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" onkeydown="if(event.key==='Enter'){event.preventDefault();document.getElementById('tutorGroup').focus();}">
      </div>
      
      <div class="form-field">
        <label for="tutorGroup"><strong>Grupo/Grado:</strong></label>
        <input id="tutorGroup" type="text" placeholder="Ej: 3Â° Primaria, Grupo A, etc." tabindex="2" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" onkeydown="if(event.key==='Enter'){event.preventDefault();document.getElementById('btnTutorNext').focus();}">
      </div>
    </div>
    
    <div class="actions" style="margin-top: 12px;">
      <button class="btn-ghost" onclick="goToPage('page-role-select')">â—‚ Volver</button>
      <button id="btnTutorNext" onclick="goToTutorConfig()" tabindex="3">Siguiente â–¸</button>
    </div>
  </section>

  <!-- PÃ¡gina 2.5: ConfiguraciÃ³n del Tutor -->
  <section id="page-tutor-config" class="page">
    <div class="card">
      <h3>ğŸ“ ConfiguraciÃ³n del Ejercicio</h3>
      <div id="config-tutor-block"></div>
    </div>
    
    <p>Selecciona un nivel de dificultad:</p>
    
    <div class="actions" style="margin-top: 6px;">
      <button class="btn-ghost" onclick="goToPage('page-tutor-info')">â—‚ Volver</button>
      <button id="tutorNivelBasico" onclick="configurarEjercicioTutor('basico')">ğŸŒ± Nivel BÃ¡sico</button>
      <button id="tutorNivelIntermedio" onclick="configurarEjercicioTutor('intermedio')">ğŸŒ¿ Nivel Intermedio</button>
      <button id="tutorNivelAvanzado" onclick="configurarEjercicioTutor('avanzado')">ğŸŒ³ Nivel Avanzado</button>
      <button id="tutorNivelExperto" onclick="configurarEjercicioTutor('experto')">ğŸ”¥ Nivel Experto</button>
      <button class="btn-ghost" type="button" onclick="refrescarDatosRAE()" title="Limpiar cachÃ© del JSON y recargar">â†» Refrescar datos</button>
    </div>
  </section>

  <!-- PÃ¡gina 2.6: Panel del Tutor (despuÃ©s de configurar) -->
  <section id="page-tutor" class="page">
    <div class="card">
      <h3>ğŸ“ Panel del Tutor</h3>
      
      <!-- Resumen de configuraciÃ³n -->
      <div id="tutorConfigSummary" class="config-summary">
        <h4>âš™ï¸ ConfiguraciÃ³n del Ejercicio</h4>
        <div id="configDetails"></div>
        <button class="btn-ghost" onclick="goToPage('page-tutor-config')" style="margin-top: 10px;">âœï¸ Modificar ConfiguraciÃ³n</button>
      </div>
      
      <div id="tutorStatus" class="status-panel">
        <p>Iniciando servidor PeerJS...</p>
      </div>
      
      <div id="sessionInfo" style="display: none;">
        <div class="session-card">
          <h4>ğŸ“¡ InformaciÃ³n de la SesiÃ³n</h4>
          <div class="session-details">
            <div class="session-header-row" style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
              <p style="margin:0;"><strong>ID de SesiÃ³n:</strong> <span id="sessionId" class="session-id">-</span></p>
              <button id="btnShowQR" onclick="showSessionQR()" title="Mostrar cÃ³digo QR de la sesiÃ³n">ğŸ“± Mostrar QR</button>
            </div>
            <p style="margin-top:8px;"><strong>Estado:</strong> <span id="serverStatus">Conectando...</span></p>
          </div>
        </div>
        <div class="tutor-controls" style="margin-bottom:12px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:center;">
          <button id="startExercise" onclick="startGroupExercise()" disabled>â–¶ï¸ Iniciar Ejercicio</button>
          <button id="tutorStopAll" class="btn-ghost" onclick="tutorToggleLockAll()">â›” Bloquear pantallas</button>
          <button id="tutorNewExercise" class="btn-ghost" onclick="tutorNewExercise()">ğŸ†• Nuevo ejercicio</button>
          <button id="tutorNewSession" class="btn-ghost" onclick="tutorNewSession()">ğŸ”„ Nueva SesiÃ³n</button>
          <button id="stopSession" onclick="stopSession()" class="btn-ghost">â¹ï¸ Terminar SesiÃ³n</button>
        </div>
        <!-- Controles de reproducciÃ³n del tutor (arriba de participantes) -->
        <div id="tutorPlayback" class="tutor-controls" style="margin: 8px 0 12px; display: none; gap: 6px; flex-direction: column; width:100%;">
          <!-- Fila superior: Mostrar palabra + Palabra actual -->
          <div class="row-top" style="display:flex; flex-direction:column; gap:8px; width:100%;">
            <div style="display:flex; align-items:center; gap:10px;">
              <label class="inline" style="display:flex; align-items:center; gap:6px;">
                <input type="checkbox" id="showCurrentWord" onchange="refreshTutorCurrentWordLabel()"> Mostrar palabra
              </label>
              <strong>Palabra actual:</strong> <span id="tutorCurrentWord">â€”</span>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
              <label class="inline" style="display:flex; align-items:center; gap:6px;">
                <input type="checkbox" id="participantAudio"> Reproducir audio en participantes
              </label>
              <span class="hint" style="font-size:12px; color:#666;">Por defecto desactivado</span>
            </div>
            <!-- Barra de progreso larga (misma que participantes) con contador a la derecha -->
            <div class="progress-row" style="display:flex; align-items:center; gap:8px; width:100%;">
              <div class="progress" style="height:8px; background:#eee; border-radius:6px; overflow:hidden; flex:1;">
                <div id="tutorOverallProgressFill" style="height:100%; width:0%; background: linear-gradient(90deg, #4CAF50, #81C784);"></div>
              </div>
              <span id="tutorOverallProgressText" class="hint">0/0</span>
            </div>
          </div>
          <!-- Fila inferior: Progreso/Resp a la izquierda y botones a la derecha -->
          <div class="row-bottom" style="display:flex; align-items:center; gap:10px; width:100%;">
            <div class="left" style="display:flex; align-items:center; gap:10px;"></div>
            <div class="actions" style="display:flex; gap:8px; flex-wrap: wrap; margin-left:auto; align-items:center;">
              <button id="tutorPlayWord" onclick="tutorPlayCurrentWord()">â–¶ï¸ Reproducir</button>
              <button id="tutorNextWord" onclick="nextWordInExercise()">Siguiente â–¶</button>
              <label class="inline" style="display:flex; align-items:center; gap:6px;">
                <input type="checkbox" id="autoAdvance"> Auto
              </label>
              <select id="autoDelay" style="min-width: 80px;">
                <option value="1500">1.5 s</option>
                <option value="2000" selected>2 s</option>
                <option value="3000">3 s</option>
                <option value="4000">4 s</option>
                <option value="5000">5 s</option>
              </select>
              <span class="hint" id="tutorResponses" style="margin-left:8px;">Resp: 0/0</span>
            </div>
          </div>
        </div>

        <div class="participants-panel">
          <h4>ğŸ‘¥ Participantes Conectados (<span id="participantCount">0</span>)</h4>
          <div id="participantsList" class="participants-list">
            <p class="no-participants">No hay participantes conectados</p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="actions">
      <button class="btn-ghost" onclick="goToPage('page-tutor-config')">â—‚ ConfiguraciÃ³n</button>
    </div>
  </section>

  <!-- PÃ¡gina 2.6: Interfaz del Participante -->
  <section id="page-participant" class="page">
    <div class="card">
      <h3>ğŸ“ Panel del Participante</h3>
      
      <div id="participantConnection" class="connection-panel">
        <div class="form-field">
          <label for="participantName"><strong>Tu Nombre:</strong></label>
          <input id="participantName" type="text" placeholder="Ingresa tu nombre y apellido" tabindex="1" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
        </div>
        <div class="form-field">
          <label for="sessionIdInput" style="display:block; margin-bottom: 6px;"><strong>ID de SesiÃ³n del Tutor (MAYÃšSCULAS):</strong></label>
          <input id="sessionIdInput" type="text" placeholder="Ingresa el ID de sesiÃ³n" style="text-align: center; font-family: monospace; text-transform: uppercase; margin-top: 6px; margin-bottom: 12px;" tabindex="2" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
          <div class="hint" style="font-size: 12px; color: #b91c1c; margin-top: 12px; text-align:center; font-weight: 600;">
            âš ï¸ Importante: el ID <strong>distingue mayÃºsculas</strong>. EscrÃ­belo en <strong>MAYÃšSCULAS</strong> (ej.: <code>TUTOR_AB12CD</code>).
          </div>
        </div>
        <button id="connectToSession" onclick="connectToSession()" tabindex="3">ğŸ”— Conectar a SesiÃ³n</button>
      </div>
      
      <div id="participantStatus" class="status-panel" style="display: none;">
        <p id="connectionStatus">Conectando...</p>
      </div>
      
      <div id="participantExercise" class="exercise-panel" style="display: none;">
        <div class="participant-info">
          <p><strong>Alumno:</strong> <span id="participantDisplayName">-</span></p>
          <p><strong>Conectado a:</strong> <span id="connectedSession">-</span></p>
          <p><strong>Estado:</strong> <span id="exerciseStatus">Esperando...</span></p>
        </div>
        
        <div id="participantGame" style="display: none;">
          <!-- Progreso del participante (arriba del cuadro de texto) -->
          <div class="participant-progress" style="margin-top: 16px;">
            <div class="progress" aria-label="Progreso de palabras">
              <div id="participantProgressFill" class="progress-fill" style="width:0%"></div>
            </div>
            <div id="participantProgressText" class="progress-text">0/0</div>
          </div>

          <div class="participant-input">
            <input type="text" id="participantAnswer" placeholder="Escribe la palabra aquÃ­" 
                   autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" 
                   data-gramm="false" onkeydown="handleParticipantEnter(event)">
            <button onclick="submitParticipantAnswer()">âœ“ Confirmar</button>
          </div>
          
          <div id="participantFeedback" class="participant-feedback"></div>
        </div>
        
        <!-- Reporte del participante (despuÃ©s del ejercicio) -->
        <div id="participantReport" style="display: none;">
          <h4>ğŸ“Š Tu Reporte</h4>
          <div class="actions" style="margin: 12px 0;">
            <button onclick="generarReportePDF()">â¬‡ï¸ Descargar PDF</button>
            <button onclick="generarPracticaManual()">ğŸ“ PrÃ¡ctica Manual</button>
          </div>
          <div id="participantReportContent"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- PÃ¡gina 3: Reporte final -->
  <section id="page-report" class="page">
    <div class="actions" style="margin-top: 6px;">
      <button class="btn-ghost" onclick="goToPage('page-config')">â—‚ Nueva SesiÃ³n</button>
      <button class="btn-ghost" onclick="irAlEjercicio()">Nuevo ejercicio</button>
      <button onclick="generarReportePDF()">â¬‡ï¸ Reporte PDF</button>
      <button onclick="generarPracticaManual()">ğŸ“ PrÃ¡ctica Manual</button>
    </div>
    <div class="card" style="margin-top: 14px;">
      <div id="reporteFinal" class="status"></div>
    </div>
  </section>

  <!-- LibrerÃ­as para generar PDF en el navegador -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.0/dist/jspdf.plugin.autotable.min.js"></script>
  <!-- PeerJS para comunicaciÃ³n P2P -->
  <script src="https://unpkg.com/peerjs@1.5.0/dist/peerjs.min.js"></script>
  <!-- Simple Keyboard (solo se inicializa en mÃ³viles/tablets) -->
  <script src="https://cdn.jsdelivr.net/npm/simple-keyboard@latest/build/index.js"></script>
  <!-- Confetti para animaciones de Ã©xito -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <!-- QRCode generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- MÃ³dulos del sistema: (se cargan mÃ¡s abajo con onload/onerror y logs) -->
  
  <!-- Modal personalizado para confirmaciÃ³n de descarga -->
  <div id="downloadModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">âœ… Descarga Completada</h3>
        <span class="modal-close" onclick="closeDownloadModal()">&times;</span>
      </div>
      <div class="modal-body">
        <p id="modalMessage">Archivo descargado exitosamente</p>
        <div class="modal-actions">
          <button id="openFileBtn" class="btn-primary" onclick="openDownloadedFile()">ğŸ“‚ Abrir Archivo</button>
          <button class="btn-ghost" onclick="closeDownloadModal()">Cancelar</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Contenedor inline para Teclado Virtual (solo mÃ³viles/tablets) -->
  <div id="vk-inline" class="vk-inline-container" style="display:none;" aria-hidden="true">
    <div class="simple-keyboard"></div>
  </div>

  </div>
  
  <!-- Pie de pÃ¡gina -->
  <footer>
    <div style="width: 100%; max-width: 980px; margin: 0 auto; text-align: center; padding: 8px 0 4px;">
      <p style="margin: 0; font-size: 12px; color: #334155; line-height: 1.4;">
        <strong>Â© 2025 GMR - Todos los derechos reservados</strong> Â· 
        <span style="font-size: 11px; color: #64748b;">CÃ³digo propietario. Prohibida su modificaciÃ³n o redistribuciÃ³n.</span>
      </p>
      <p style="margin: 2px 0 0; font-size: 11px; line-height: 1.3;">
        <a href="assets/politicas-privacidad.html" style="color: #0ea5e9; text-decoration: none; margin: 0 4px;">PolÃ­ticas de Privacidad</a> |
        <a href="LICENSE.md" style="color: #0ea5e9; text-decoration: none; margin: 0 4px;">Licencia</a> |
        <a href="mailto:hgomero@gmail.com" style="color: #0ea5e9; text-decoration: none; margin: 0 4px;">Contacto</a>
      </p>
    </div>
  </footer>
  
  <!-- Modal para QR de sesiÃ³n (fuera de secciones .page) -->
  <div id="qrModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width:420px;">
      <div class="modal-header">
        <h3>ConÃ©ctate por QR</h3>
        <span class="modal-close" onclick="closeQRModal()">&times;</span>
      </div>
      <div class="modal-body" style="display:flex; align-items:center; justify-content:center; flex-direction:column; gap:12px;">
        <div id="qrCodeContainer" style="width:256px; height:256px;"></div>
        <div id="qrSessionIdRow" class="hint" style="font-size:13px; color:#334155; background:#f8fafc; border:1px solid #e5e7eb; border-radius:8px; padding:8px 10px;">
          ID de SesiÃ³n: <code id="qrSessionId" style="font-weight:700; color:#0ea5e9;">-</code>
        </div>
        <div class="hint" style="font-size:12px; color:#64748b;">Escanea con el dispositivo del participante. PrecargarÃ¡ el ID de sesiÃ³n automÃ¡ticamente.</div>
      </div>
      <div class="modal-actions" style="justify-content:center;">
        <button class="btn-primary" onclick="closeQRModal()">Cerrar</button>
      </div>
    </div>
  </div>
  
  
  
  <!-- Scripts principales -->
  <!-- Device Detector debe cargarse primero -->
  <script src="modules/device-detector.js" onload="console.log('âœ… modules/device-detector.js cargado')" onerror="console.error('âŒ Error cargando modules/device-detector.js')"></script>
  <script src="modules/virtual-keyboard.js" onload="console.log('âœ… modules/virtual-keyboard.js cargado')" onerror="console.error('âŒ Error cargando modules/virtual-keyboard.js')"></script>
  <script src="modules/cache.js" onload="console.log('âœ… modules/cache.js cargado')" onerror="console.error('âŒ Error cargando modules/cache.js')"></script>
  <script src="modules/navigation.js" onload="console.log('âœ… modules/navigation.js cargado')" onerror="console.error('âŒ Error cargando modules/navigation.js')"></script>
  <script src="modules/voice-strategy.js" onload="console.log('âœ… modules/voice-strategy.js cargado')" onerror="console.error('âŒ Error cargando modules/voice-strategy.js')"></script>
  <script src="modules/tts.js" onload="console.log('âœ… modules/tts.js cargado')" onerror="console.error('âŒ Error cargando modules/tts.js')"></script>
  <!-- Config debe cargarse antes de data-loader y resto de mÃ³dulos -->
  <script src="modules/config.js" onload="console.log('âœ… modules/config.js cargado')" onerror="console.error('âŒ Error cargando modules/config.js')"></script>
  <!-- Definir ruta del JSON antes del cargador de datos -->
  <script>
    // Overrides opcionales de CONFIG (si quieres cambiar por entorno)
    window.CONFIG = Object.assign(window.CONFIG || {}, {
      RAE_WORD_LIST_URL: './assets/palabras-con-frecuencia.json'
    });
    // Activar diagnÃ³sticos si se requiere
    window.DEBUG = window.DEBUG ?? true;
  </script>
  <!-- Eliminado: diccionario externo; validaciÃ³n se hace localmente -->
  <script src="modules/data-loader.js?v=dbg1" onload="console.log('âœ… modules/data-loader.js cargado')" onerror="console.error('âŒ Error cargando modules/data-loader.js')"></script>
  <script src="modules/data.js" onload="console.log('âœ… modules/data.js cargado')" onerror="console.error('âŒ Error cargando modules/data.js')"></script>
  <script src="modules/rae-proxy.js" onload="console.log('âœ… modules/rae-proxy.js cargado')" onerror="console.error('âŒ Error cargando modules/rae-proxy.js')"></script>
  <script src="modules/dev-utils.js" onload="console.log('âœ… modules/dev-utils.js cargado')" onerror="console.error('âŒ Error cargando modules/dev-utils.js')"></script>
  <script src="modules/group-state.js" onload="console.log('âœ… modules/group-state.js cargado')" onerror="console.error('âŒ Error cargando modules/group-state.js')"></script>
  <script src="modules/peer-manager.js" onload="console.log('âœ… modules/peer-manager.js cargado')" onerror="console.error('âŒ Error cargando modules/peer-manager.js')"></script>
  <script src="modules/game-state.js" onload="console.log('âœ… modules/game-state.js cargado')" onerror="console.error('âŒ Error cargando modules/game-state.js')"></script>
  <script src="modules/reportes.js" onload="console.log('âœ… modules/reportes.js cargado')" onerror="console.error('âŒ Error cargando modules/reportes.js')"></script>
  <script src="modules/ui.js" onload="console.log('âœ… modules/ui.js cargado')" onerror="console.error('âŒ Error cargando modules/ui.js')"></script>
  <script src="modules/ui-core.js" onload="console.log('âœ… modules/ui-core.js cargado')" onerror="console.error('âŒ Error cargando modules/ui-core.js')"></script>
  <script src="modules/ui-forms.js" onload="console.log('âœ… modules/ui-forms.js cargado')" onerror="console.error('âŒ Error cargando modules/ui-forms.js')"></script>
  <script src="modules/progress.js" onload="console.log('âœ… modules/progress.js cargado')" onerror="console.error('âŒ Error cargando modules/progress.js')"></script>
  <script src="modules/vk-helpers.js" onload="console.log('âœ… modules/vk-helpers.js cargado')" onerror="console.error('âŒ Error cargando modules/vk-helpers.js')"></script>
  <script src="modules/params.js" onload="console.log('âœ… modules/params.js cargado')" onerror="console.error('âŒ Error cargando modules/params.js')"></script>
  <script src="modules/error-bank.js" onload="console.log('âœ… modules/error-bank.js cargado')" onerror="console.error('âŒ Error cargando modules/error-bank.js')"></script>
  <script src="modules/validation.js" onload="console.log('âœ… modules/validation.js cargado')" onerror="console.error('âŒ Error cargando modules/validation.js')"></script>
  <script src="modules/router.js" onload="console.log('âœ… modules/router.js cargado')" onerror="console.error('âŒ Error cargando modules/router.js')"></script>
  <script src="modules/game-flow.js" onload="console.log('âœ… modules/game-flow.js cargado')" onerror="console.error('âŒ Error cargando modules/game-flow.js')"></script>
  <!-- Ayudas por pÃ¡gina -->
  <script src="modules/page-hints.js" onload="console.log('âœ… modules/page-hints.js cargado')" onerror="console.error('âŒ Error cargando modules/page-hints.js')"></script>
  <script src="modules/feedback.js" onload="console.log('âœ… modules/feedback.js cargado')" onerror="console.error('âŒ Error cargando modules/feedback.js')"></script>
  <!-- Debe cargarse antes de app.js para que los wrappers deleguen correctamente -->
  <script src="modules/individual-mode.js?v=dbg1" onload="console.log('âœ… modules/individual-mode.js cargado')" onerror="console.error('âŒ Error cargando modules/individual-mode.js')"></script>
  <!-- MÃ³dulos del modo grupal -->
  <script src="modules/participant-helpers.js" onload="console.log('âœ… modules/participant-helpers.js cargado')" onerror="console.error('âŒ Error cargando modules/participant-helpers.js')"></script>
  <script src="modules/group-mode-tutor.js" onload="console.log('âœ… modules/group-mode-tutor.js cargado')" onerror="console.error('âŒ Error cargando modules/group-mode-tutor.js')"></script>
  <script src="modules/config-block.js" onload="console.log('âœ… modules/config-block.js cargado')" onerror="console.error('âŒ Error cargando modules/config-block.js')"></script>
  <script src="assets/app.js?v=qr2" onload="console.log('âœ… app.js cargado (qr2)')" onerror="console.error('âŒ Error cargando app.js')"></script>
  <script>
    // Renderizar los bloques reutilizables cuando el DOM estÃ© listo
    (function(){
      const init = function(){
        try {
          if (window.renderConfigBlock) {
            const ci = document.getElementById('config-individual-block');
            if (ci) window.renderConfigBlock(ci, { mode: 'individual' });
            const ct = document.getElementById('config-tutor-block');
            if (ct) window.renderConfigBlock(ct, { mode: 'tutor' });
          }
        } catch(e) { console.error('Error renderizando config-block:', e); }
      };
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
      else init();
    })();
  </script>
  
  <!-- Eliminado: script de diagnÃ³stico duplicado -->
  
  <!-- Inicializador del teclado virtual (solo mÃ³viles/tablets) -->
  <script>
    (function(){
      function initVK(){
        try {
          if (window.initVirtualKeyboardIfNeeded) {
            window.initVirtualKeyboardIfNeeded();
          }
        } catch (e) {
          console.warn('[VK] No se pudo inicializar el teclado virtual:', e);
        }
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initVK);
      } else {
        initVK();
      }
    })();
  </script>
  
  <!-- Deshabilitar menÃº contextual y herramientas de desarrollador -->
  <script>
    // Bloquear menÃº contextual
    document.addEventListener('contextmenu', event => event.preventDefault());
    
    // Bloquear teclas de desarrollador (mÃºltiples eventos para mayor cobertura)
    const blockDevTools = (e) => {
      // F12
      if (e.key === "F12" || e.keyCode === 123) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      // Ctrl+Shift+I (Inspector)
      if (e.ctrlKey && e.shiftKey && (e.key === "I" || e.keyCode === 73)) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      // Ctrl+Shift+J (Console)
      if (e.ctrlKey && e.shiftKey && (e.key === "J" || e.keyCode === 74)) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      // Ctrl+Shift+C (Selector)
      if (e.ctrlKey && e.shiftKey && (e.key === "C" || e.keyCode === 67)) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      // Ctrl+U (Ver cÃ³digo fuente)
      if (e.ctrlKey && (e.key === "U" || e.keyCode === 85)) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
    };
    
    // Aplicar en mÃºltiples eventos
    document.addEventListener('keydown', blockDevTools, true);
    document.addEventListener('keypress', blockDevTools, true);
    document.addEventListener('keyup', blockDevTools, true);
    
    // Detectar si DevTools estÃ¡ abierto (truco basado en timing)
    const devToolsCheck = () => {
      const threshold = 160;
      const widthThreshold = window.outerWidth - window.innerWidth > threshold;
      const heightThreshold = window.outerHeight - window.innerHeight > threshold;
      
      if (widthThreshold || heightThreshold) {
        document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:Arial;"><h2>âš ï¸ Por favor, cierra las herramientas de desarrollador para continuar.</h2></div>';
      }
    };
    
    // Verificar periÃ³dicamente
    setInterval(devToolsCheck, 1000);
  </script>
</body>
</html>
